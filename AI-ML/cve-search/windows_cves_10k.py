import requests
import pandas as pd
import time

def fetch_windows_cves(start_index=0, results_per_page=2000):
    """Fetch Windows CVEs from NVD API with pagination"""
    url = f"https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Windows&startIndex={start_index}&resultsPerPage={results_per_page}"
    headers = {"User-Agent": "Mozilla/5.0"}  # Avoid 403 errors
    try:
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        return response.json()
    except Exception as e:
        print(f"Error: {e}")
        return None

def parse_windows_cves(response):
    """Extract Windows-specific CVEs with port/feature details"""
    cve_list = []
    if not response or 'vulnerabilities' not in response:
        return cve_list
    
    for vuln in response['vulnerabilities']:
        cve = vuln['cve']
        description = cve['descriptions'][0]['value'].lower()
        
        # Filter for Windows components
        keywords = ['windows', 'iis', 'active directory', 'rdp', 'smb', 'powershell', 
                   'exchange', 'office', 'sql server', 'hyper-v', 'wsl', 'winrm']
        if any(kw in description for kw in keywords):
            cve_list.append({
                'CVE': cve['id'],
                'Published': cve['published'],
                'Vendor': cve.get('sourceIdentifier', 'N/A'),
                'Product': 'Windows',
                'CVSS': cve['metrics']['cvssMetricV3'][0]['cvssData']['baseScore'] if 'cvssMetricV3' in cve['metrics'] else 'N/A',
                'Description': description,
                'Ports': get_ports_from_description(description),  # Custom function
                'Component': get_component(description)  # Custom function
            })
    return cve_list

def get_ports_from_description(desc):
    """Extract ports mentioned in CVE descriptions"""
    ports = []
    common_ports = {
        'rdp': '3389', 'smb': '445', 'winrm': '5985', 
        'iis': '80/443', 'sql': '1433', 'ldap': '389'
    }
    for term, port in common_ports.items():
        if term in desc:
            ports.append(port)
    return ";".join(ports) if ports else "N/A"

def get_component(desc):
    """Identify affected Windows components"""
    components = {
        'active directory': 'Active Directory',
        'iis': 'IIS', 'rdp': 'Remote Desktop',
        'smb': 'SMB', 'powershell': 'PowerShell',
        'exchange': 'Exchange Server'
    }
    for term, component in components.items():
        if term in desc:
            return component
    return "Windows OS"

def main():
    all_cves = []
    total_cves = 10000
    max_retries = 3
    
    for start_index in range(0, total_cves, 2000):
        retries = 0
        while retries < max_retries:
            print(f"Fetching {start_index + 1}-{start_index + 2000}...")
            data = fetch_windows_cves(start_index)
            if data:
                cves = parse_windows_cves(data)
                all_cves.extend(cves)
                break
            retries += 1
            time.sleep(10)
        time.sleep(6)  # Respect NVD rate limits
    
    df = pd.DataFrame(all_cves)
    df.to_csv('windows_cves_10k.csv', index=False)
    print(f"Saved {len(df)} Windows CVEs to 'windows_cves_10k.csv'")

if __name__ == "__main__":
    main()