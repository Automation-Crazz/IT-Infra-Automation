import requests
import pandas as pd
import time

def fetch_cves(start_index, results_per_page=2000):
    url = f"https://services.nvd.nist.gov/rest/json/cves/2.0?keywordSearch=Linux&startIndex={start_index}&resultsPerPage={results_per_page}"
    try:
        response = requests.get(url)
        response.raise_for_status()  # Check for HTTP errors
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"Error fetching data: {e}")
        return None

def parse_cves(response):
    cve_list = []
    if not response or 'vulnerabilities' not in response:
        return cve_list
    for vuln in response['vulnerabilities']:
        cve = vuln['cve']
        cve_list.append({
            'CVE': cve['id'],
            'Published': cve['published'],
            'Vendor': cve.get('sourceIdentifier', 'N/A'),
            'Product': 'Linux',
            'CVSS': cve['metrics']['cvssMetricV3'][0]['cvssData']['baseScore'] if 'cvssMetricV3' in cve['metrics'] else 'N/A',
            'Description': cve['descriptions'][0]['value']
        })
    return cve_list

def main():
    all_cves = []
    total_results = 5000
    results_per_page = 2000  # Max allowed by NVD
    max_retries = 3

    for start_index in range(0, total_results, results_per_page):
        retries = 0
        while retries < max_retries:
            print(f"Fetching CVEs {start_index + 1} to {start_index + results_per_page}...")
            response = fetch_cves(start_index, results_per_page)
            if response:
                cves = parse_cves(response)
                all_cves.extend(cves)
                break
            else:
                retries += 1
                time.sleep(10)  # Wait 10 seconds before retrying
        if retries == max_retries:
            print(f"Failed to fetch data after {max_retries} retries.")
            break
        time.sleep(6)  # Respect NVD's rate limit (5 requests/30 seconds)

    # Save to CSV
    df = pd.DataFrame(all_cves)
    df.to_csv('linux_cves_5000.csv', index=False)
    print(f"Saved {len(df)} CVEs to 'linux_cves_5000.csv'")

if __name__ == "__main__":
    main()